<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IBBA Club Multi-Team Roster Submission ‚Äì Pixellot Advantage</title>
  <meta name="description" content="IBBA multi-team roster submission with progress tracking and bulk operations." />

  <style>
    :root {
      --bg: #f8fafc; --bg-2: #e2e8f0; --card: #ffffff; --ink: #1e293b; --ink-2: #374151;
      --muted: #64748b; --brand: #3b82f6; --brand-600: #2563eb; --ok: #10b981; --ok-600: #059669;
      --warn: #f59e0b; --err: #ef4444; --err-bg: #fef2f2; --err-brd: #fecaca; --ring: rgba(59,130,246,.12); --brd: #e2e8f0;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; padding: 20px; min-height: 100vh; background: linear-gradient(135deg, var(--bg) 0%, var(--bg-2) 100%);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; color: var(--ink); }
    
    .container { max-width: 1400px; margin: 0 auto; background: var(--card); border: 1px solid var(--brd); border-radius: 12px; padding: 32px;
      box-shadow: 0 4px 6px rgba(0,0,0,.07), 0 1px 3px rgba(0,0,0,.06); }
    
    h1 { font-size: clamp(1.8rem, 2.2vw, 2.5rem); font-weight: 800; text-align: center; margin: 0 0 6px; }
    .subtitle { text-align: center; color: var(--muted); margin-bottom: 14px; }
    .version-info { text-align: center; margin-bottom: 24px; font-size: .95rem; color: var(--muted); }
    .version { background: var(--brand); color: #fff; padding: 4px 12px; border-radius: 16px; font-weight: 700; margin-right: 10px; box-shadow: 0 1px 3px rgba(59,130,246,.3); }

    /* Progress Bar */
    .progress-container { margin-bottom: 32px; }
    .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-bottom: 16px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--brand), var(--brand-600)); transition: width 0.3s ease; border-radius: 4px; }
    
    .steps { 
      display: flex; 
      flex-direction: row !important; 
      justify-content: space-between; 
      margin-bottom: 16px; 
      gap: 16px; 
    }
    .step { 
      display: flex; 
      flex-direction: row !important;
      align-items: center; 
      flex: 1; 
      justify-content: center; 
    }
    .step-circle { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; margin-right: 8px; position: relative; z-index: 1; }
    .step.pending .step-circle { background: #e5e7eb; color: var(--muted); }
    .step.active .step-circle { background: var(--brand); color: white; }
    .step.completed .step-circle { background: var(--ok); color: white; }
    .step-label { font-size: 14px; font-weight: 600; }
    .step.pending .step-label { color: var(--muted); }
    .step.active .step-label { color: var(--brand); }
    .step.completed .step-label { color: var(--ok); }

    /* Form Steps */
    .form-step { display: none; }
    .form-step.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .form-section { margin-bottom: 24px; background: #f8fafc; padding: 20px; border-radius: 10px; border: 1px solid var(--brd); }
    .form-section h2 { font-size: 1.15rem; font-weight: 700; margin: 0 0 14px; }
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 14px; }
    .col-6 { grid-column: span 6; } .col-4 { grid-column: span 4; } .col-3 { grid-column: span 3; } .col-12 { grid-column: 1 / -1; }
    label { display: block; font-weight: 700; color: var(--ink-2); margin-bottom: 6px; }
    input, select { width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 16px; background: #fff; }
    input:focus, select:focus { outline: none; border-color: var(--brand); box-shadow: 0 0 0 4px var(--ring); }

    /* Inline field error */
    .field-error { display:none; margin-top:6px; padding:10px 12px; border-radius:8px;
      background: var(--err-bg); border:1px solid var(--err-brd); color:#991b1b; font-weight:600; font-size:.9rem; }
    .input-error { border-color: var(--err) !important; background: var(--err-bg) !important; }

    /* Teams Management */
    .teams-section { margin-bottom: 28px; }
    .teams-section h2 { font-size: 1.35rem; font-weight: 800; margin: 0 0 14px; position: relative; }
    .teams-section h2::after { content: ""; position: absolute; bottom: -6px; left: 0; width: 90px; height: 3px; background: var(--brand); }

    .team-card { background: #fff; border: 2px solid var(--brd); border-radius: 12px; padding: 20px; margin-bottom: 16px; position: relative; transition: all 0.2s ease; }
    .team-card:hover { border-color: var(--brand); box-shadow: 0 4px 12px rgba(59,130,246,0.1); }
    .team-card.complete { border-color: var(--ok); background: linear-gradient(135deg, #f0fdf4 0%, #f9fdf9 100%); }
    .team-card.incomplete { border-color: var(--warn); }

    .team-header { display: flex; justify-content: between; align-items: center; margin-bottom: 16px; }
    .team-title { font-size: 1.2rem; font-weight: 700; color: var(--ink); flex-grow: 1; }
    .team-status { padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
    .team-status.complete { background: var(--ok); color: white; }
    .team-status.incomplete { background: var(--warn); color: white; }
    .team-status.empty { background: #e5e7eb; color: var(--muted); }

    .team-info { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; align-items: end; }
    .remove-team { background: var(--err); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .remove-team:hover { background: #dc2626; }

    .add-team-card { border: 2px dashed var(--brd); background: #f9fafb; text-align: center; padding: 40px 20px; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; }
    .add-team-card:hover { border-color: var(--brand); background: #f0f9ff; }
    .add-team-icon { font-size: 2rem; color: var(--brand); margin-bottom: 12px; }

    /* Roster Management */
    .roster-section { margin-bottom: 28px; }
    .roster-section h2 { font-size: 1.35rem; font-weight: 800; margin: 0 0 14px; position: relative; }
    .roster-section h2::after { content: ""; position: absolute; bottom: -6px; left: 0; width: 90px; height: 3px; background: var(--brand); }

    .team-selector { margin-bottom: 20px; }
    .team-tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
    .team-tab { padding: 10px 16px; border: 2px solid var(--brd); border-radius: 8px; background: #fff; cursor: pointer; font-weight: 600; transition: all 0.2s ease; position: relative; }
    .team-tab:hover { border-color: var(--brand); }
    .team-tab.active { border-color: var(--brand); background: var(--brand); color: white; }
    .team-tab.complete::after { content: "‚úì"; position: absolute; top: -8px; right: -8px; background: var(--ok); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; }

    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; border: 1px solid var(--brd); }
    th { background: #f8fafc; color: #374151; padding: 12px 10px; text-align: left; font-size: .8rem; text-transform: uppercase; letter-spacing: .4px; border-bottom: 2px solid #e5e7eb; }
    td { padding: 8px 10px; border-bottom: 1px solid #f3f4f6; }
    tr:hover { background: #f9fafb; } tr:nth-child(even) { background: #fbfcff; }
    .staff-row { background: #f0f9ff !important; }
    .jersey-input { text-align: center; font-weight: 700; }
    .duplicate { border-color: var(--err) !important; background: var(--err-bg) !important; }
    .invalid-email { border-color: var(--err) !important; background: var(--err-bg) !important; }

    /* Bulk Operations */
    .bulk-ops { margin-bottom: 16px; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #0ea5e9; border-radius: 12px; }
    .bulk-ops h3 { margin: 0 0 16px; font-size: 16px; font-weight: 700; color: #0369a1; display: flex; align-items: center; gap: 8px; }
    
    .bulk-workflow { display: flex; gap: 24px; align-items: flex-start; margin-bottom: 16px; }
    .bulk-step { display: flex; align-items: flex-start; gap: 12px; flex: 1; }
    .step-number { width: 28px; height: 28px; background: var(--brand); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; flex-shrink: 0; margin-top: 4px; }
    .step-content { display: flex; flex-direction: column; gap: 6px; width: 100%; }
    .step-content label { font-size: 14px; font-weight: 600; color: #1e40af; margin: 0; }
    .step-content small { color: #64748b; font-size: 12px; line-height: 1.3; }
    
    .bulk-select-all { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .bulk-select-all input { width: auto; margin: 0; }
    
    .bulk-select { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; background: white; width: 100%; }
    .bulk-step .btn { margin-right: 8px; margin-bottom: 4px; padding: 8px 16px; font-size: 14px; }
    
    .bulk-status { padding: 12px 16px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 8px; text-align: center; }
    .bulk-status span { font-weight: 600; color: var(--brand); }
    
    .selected-row { background-color: #dbeafe !important; border-left: 4px solid var(--brand) !important; }

    .status { display: none; padding: 12px 14px; border-radius: 10px; margin-bottom: 12px; font-weight: 600; }
    .status--warn { background: var(--err-bg); color: #991b1b; border: 1px solid var(--err-brd); }
    .status--ok { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }

    .buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
    .btn { padding: 12px 18px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; transition: transform .12s ease, background .12s ease, opacity .12s ease; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn-primary { background: var(--brand); color: #fff; } .btn-primary:hover:not(:disabled) { background: var(--brand-600); transform: translateY(-1px); }
    .btn-secondary { background: #6b7280; color: #fff; } .btn-secondary:hover:not(:disabled) { background: #4b5563; transform: translateY(-1px); }
    .btn-success { background: var(--ok); color: #fff; } .btn-success:hover:not(:disabled) { background: var(--ok-600); transform: translateY(-1px); }
    .btn-outline { background: transparent; color: var(--ink-2); border: 1px solid var(--brd); }

    .loading { display: none; text-align: center; color: var(--brand); font-weight: 800; margin-top: 10px; }
    .table-tools { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }

    .step-navigation { display: flex; justify-content: space-between; margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--brd); }

    .no-teams-message { text-align: center; padding: 60px 20px; color: var(--muted); }
    .no-teams-message .icon { font-size: 3rem; margin-bottom: 16px; }

    .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
    .overview-card { background: #fff; border: 1px solid var(--brd); border-radius: 10px; padding: 20px; }
    .overview-card h3 { margin: 0 0 12px; color: var(--brand); }
    .overview-stats { display: flex; gap: 16px; margin-bottom: 12px; }
    .stat { text-align: center; }
    .stat-number { font-size: 1.5rem; font-weight: 700; color: var(--brand); }
    .stat-label { font-size: 12px; color: var(--muted); text-transform: uppercase; }

    /* Mandatory field indicator */
    .required::after {
      content: " *";
      color: var(--err);
      font-weight: bold;
    }

    /* Tooltip styles */
    .tooltip {
      position: relative;
      cursor: help;
      display: inline-block;
    }

    .tooltip::after {
      content: "‚ÑπÔ∏è";
      position: absolute;
      right: -18px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      opacity: 0.6;
      pointer-events: none;
    }

    .tooltip:hover::after {
      opacity: 1;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 260px;
      background-color: #333;
      color: #fff;
      text-align: left;
      border-radius: 6px;
      padding: 8px 12px;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 0;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      pointer-events: none;
    }

    /* Smart positioning - adjust if tooltip would go off-screen */
    .tooltip .tooltiptext::before {
      content: "";
      position: absolute;
      top: 100%;
      left: 20px;
      border-width: 5px;
      border-style: solid;
      border-color: #333 transparent transparent transparent;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    /* Right-aligned tooltip for elements near the right edge */
    .tooltip.tooltip-right .tooltiptext {
      left: auto;
      right: 0;
    }

    .tooltip.tooltip-right .tooltiptext::before {
      left: auto;
      right: 20px;
    }

    /* Mobile and small screen adjustments */
    @media (max-width: 900px) {
      .tooltip::after {
        right: -15px;
        font-size: 11px;
      }
      
      .tooltip .tooltiptext {
        width: 220px;
        font-size: 12px;
        left: -50px;
        max-width: calc(100vw - 40px);
      }
      
      .tooltip.tooltip-right .tooltiptext {
        right: -50px;
        left: auto;
      }
    }

    /* Ensure tooltips don't break container boundaries */
    @media (max-width: 600px) {
      .tooltip .tooltiptext {
        width: 200px;
        left: -75px;
      }
      
      .tooltip.tooltip-right .tooltiptext {
        right: -75px;
        left: auto;
      }
    }
      .col-6, .col-4, .col-3 { grid-column: 1 / -1; }
      .container { padding: 18px; }
      table { display: block; overflow-x: auto; white-space: nowrap; }
      .bulk-workflow { flex-direction: column; gap: 16px; }
      .bulk-step { flex-direction: row; align-items: center; }
      .step-content { margin-left: 8px; }
      .steps { flex-direction: column; gap: 8px; }
      .step::after { display: none; }
      .team-info { grid-template-columns: 1fr; gap: 12px; }
      .team-tabs { justify-content: center; }
      .overview-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container" role="main">
    <h1>üèÄ IBBA Club Multi-Team Roster Submission</h1>
    <p class="subtitle">Submit rosters for multiple teams from your club ‚Ä¢ Powered by Pixellot Advantage</p>

    <div class="version-info" aria-live="polite">
      <span id="versionBadge" class="version">Version 5.4.0 - ENHANCED</span>
      <span class="date">Updated: August 2025</span>
    </div>

    <!-- Progress Indicator -->
    <div class="progress-container">
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill" style="width: 25%"></div>
      </div>
      <div class="steps">
        <div class="step active" data-step="1">
          <div class="step-circle">1</div>
          <div class="step-label">Club Info</div>
        </div>
        <div class="step pending" data-step="2">
          <div class="step-circle">2</div>
          <div class="step-label">Teams</div>
        </div>
        <div class="step pending" data-step="3">
          <div class="step-circle">3</div>
          <div class="step-label">Rosters</div>
        </div>
        <div class="step pending" data-step="4">
          <div class="step-circle">4</div>
          <div class="step-label">Review</div>
        </div>
      </div>
    </div>

    <form id="clubForm" novalidate>
      <!-- Step 1: Club Information -->
      <div class="form-step active" data-step="1">
        <section class="form-section" aria-labelledby="club-info-h">
          <h2 id="club-info-h">üèÜ Club Information</h2>
          <div class="grid">
            <div class="col-6">
              <label for="clubName" class="required tooltip">Club Name
                <span class="tooltiptext">Enter your basketball club's official name (e.g., "Hapoel Kfar Saba", "Maccabi Tel Aviv")</span>
              </label>
              <input id="clubName" name="clubName" type="text" placeholder="e.g., Hapoel Kfar Saba" autocomplete="organization" required />
              <div id="clubNameError" class="field-error" role="alert" aria-live="assertive"></div>
            </div>
            <div class="col-6">
              <label for="season" class="required tooltip">Season
                <span class="tooltiptext">Select the basketball season year for this roster submission</span>
              </label>
              <select id="season" name="season" required></select>
              <div id="seasonError" class="field-error" role="alert" aria-live="assertive"></div>
            </div>
          </div>
        </section>

        <section class="form-section" aria-labelledby="contact-h">
          <h2 id="contact-h">üìù Contact Information</h2>
          <div class="grid">
            <div class="col-6">
              <label for="submitterName" class="required tooltip">Your Name
                <span class="tooltiptext">Enter your full name as the person submitting this roster (coach, manager, or club official)</span>
              </label>
              <input id="submitterName" name="submitterName" type="text" placeholder="Enter your full name" autocomplete="name" required />
              <div id="submitterNameError" class="field-error" role="alert" aria-live="assertive"></div>
            </div>
            <div class="col-6">
              <label for="submitterEmail" class="required tooltip">Your Email
                <span class="tooltiptext">Enter your email address - this will be included in the CSV file for contact purposes</span>
              </label>
              <input id="submitterEmail" name="submitterEmail" type="email" placeholder="Enter your email address" autocomplete="email" inputmode="email" required />
              <div id="submitterEmailError" class="field-error" role="alert" aria-live="assertive"></div>
            </div>
          </div>
        </section>
      </div>

      <!-- Step 2: Teams Management -->
      <div class="form-step" data-step="2">
        <section class="teams-section" aria-labelledby="teams-h">
          <h2 id="teams-h">üë• Team Management</h2>
          <p class="subtitle">Add all the teams from your club that need roster submission</p>
          
          <div id="teamsContainer">
            <!-- Teams will be added here dynamically -->
          </div>
          
          <div class="add-team-card" id="addTeamCard">
            <div class="add-team-icon">‚ûï</div>
            <h3>Add New Team</h3>
            <p>Click to add another team to your club</p>
          </div>
        </section>
      </div>

      <!-- Step 3: Rosters -->
      <div class="form-step" data-step="3">
        <div id="noTeamsMessage" class="no-teams-message">
          <div class="icon">üèÄ</div>
          <h3>No Teams Added Yet</h3>
          <p>Go back to step 2 to add teams before managing rosters</p>
        </div>

        <div id="rosterManagement" style="display: none;">
          <section class="roster-section" aria-labelledby="roster-h">
            <h2 id="roster-h">üìù Team Rosters</h2>
            
            <div class="team-selector">
              <p class="subtitle">Select a team to manage its roster</p>
              <div id="teamTabs" class="team-tabs">
                <!-- Team tabs will be added here dynamically -->
              </div>
            </div>

            <div id="activeRosterSection" style="display: none;">
              <div id="dupWarn" class="status status--warn" role="alert" aria-live="assertive"></div>
              <div id="emailWarn" class="status status--warn" role="alert" aria-live="assertive"></div>
              
              <!-- Players Section -->
              <div class="roster-section">
                <h3>üéØ Players</h3>
                
                <!-- Bulk Operations -->
                <div class="bulk-ops">
                  <h3>‚ö° Bulk Operations</h3>
                  <div class="bulk-workflow">
                    <div class="bulk-step">
                      <span class="step-number">1</span>
                      <div class="step-content">
                        <label class="bulk-select-all">
                          <input type="checkbox" id="selectAllPlayers">
                          <strong>Select Players</strong>
                        </label>
                        <small>Check individual players below or use "Select All"</small>
                      </div>
                    </div>
                    
                    <div class="bulk-step">
                      <span class="step-number">2</span>
                      <div class="step-content">
                        <label for="bulkPosition"><strong>Choose Position</strong></label>
                        <select id="bulkPosition" class="bulk-select">
                          <option value="">Choose position to apply...</option>
                          <option value="G">üèÉ‚Äç‚ôÇÔ∏è Guard (G)</option>
                          <option value="F">üèÄ Forward (F)</option>
                          <option value="C">üè¢ Center (C)</option>
                        </select>
                      </div>
                    </div>
                    
                    <div class="bulk-step">
                      <span class="step-number">3</span>
                      <div class="step-content">
                        <button type="button" class="btn btn-primary" id="applyBulkPosition">
                          ‚ú® Apply Position
                        </button>
                        <button type="button" class="btn btn-outline" id="clearSelected">
                          üóëÔ∏è Clear Selection
                        </button>
                      </div>
                    </div>
                  </div>
                  
                  <div id="bulkStatus" class="bulk-status">
                    <span id="selectionCount">0 players selected</span>
                  </div>
                </div>

                <div class="table-tools">
                  <button type="button" class="btn btn-outline" id="addRowBtn">+ Add Player</button>
                  <button type="button" class="btn btn-outline" id="removeRowBtn">‚àí Remove Last</button>
                  <span id="rowCountHelp" class="subtitle" aria-live="polite">0 rows</span>
                </div>
                
                <table aria-describedby="rowCountHelp">
                  <thead>
                    <tr>
                      <th style="width:40px">Select</th>
                      <th style="width:64px">S/N</th>
                      <th style="width:90px">Jersey #</th>
                      <th style="min-width:160px">First Name</th>
                      <th style="min-width:160px">Last Name</th>
                      <th style="width:90px">Height (CM)</th>
                      <th style="width:100px">Position</th>
                      <th style="min-width:220px">Email Address</th>
                    </tr>
                  </thead>
                  <tbody id="playersTable"></tbody>
                </table>
              </div>

              <!-- Staff Section -->
              <div class="roster-section">
                <h3>üë®‚Äçüíº Coaching Staff</h3>
                <p class="subtitle" style="margin-bottom: 16px; font-size: 14px; color: #64748b;">
                  <strong>Head Coach:</strong> All fields required. 
                  <strong>Other Staff:</strong> If any field is filled, all fields are required for that person.
                </p>
                <table>
                  <thead>
                    <tr>
                      <th style="width:64px">S/N</th>
                      <th style="width:140px">Role</th>
                      <th>First Name</th>
                      <th>Last Name</th>
                      <th style="width:100px">Position</th>
                      <th>Email Address</th>
                      <th style="width:140px">Phone</th>
                    </tr>
                  </thead>
                  <tbody id="staffTable">
                    <tr class="staff-row">
                      <td>17</td>
                      <td><strong>Head Coach</strong></td>
                      <td><input type="text" name="coach_first" placeholder="First name" required /></td>
                      <td><input type="text" name="coach_last" placeholder="Last name" required /></td>
                      <td>-</td>
                      <td><input type="email" name="coach_email" placeholder="Email" required /></td>
                      <td><input type="tel" name="coach_phone" placeholder="Phone" inputmode="tel" required /></td>
                    </tr>
                    <tr class="staff-row">
                      <td>18</td>
                      <td><strong>Asst. Coach</strong></td>
                      <td><input type="text" name="asst1_first" placeholder="First name (optional)" /></td>
                      <td><input type="text" name="asst1_last" placeholder="Last name (optional)" /></td>
                      <td>-</td>
                      <td><input type="email" name="asst1_email" placeholder="Email (optional)" /></td>
                      <td><input type="tel" name="asst1_phone" placeholder="Phone (optional)" inputmode="tel" /></td>
                    </tr>
                    <tr class="staff-row">
                      <td>19</td>
                      <td><strong>Asst. Coach</strong></td>
                      <td><input type="text" name="asst2_first" placeholder="First name (optional)" /></td>
                      <td><input type="text" name="asst2_last" placeholder="Last name (optional)" /></td>
                      <td>-</td>
                      <td><input type="email" name="asst2_email" placeholder="Email (optional)" /></td>
                      <td><input type="tel" name="asst2_phone" placeholder="Phone (optional)" inputmode="tel" /></td>
                    </tr>
                    <tr class="staff-row">
                      <td>20</td>
                      <td><strong>Asst. Coach</strong></td>
                      <td><input type="text" name="asst3_first" placeholder="First name (optional)" /></td>
                      <td><input type="text" name="asst3_last" placeholder="Last name (optional)" /></td>
                      <td>-</td>
                      <td><input type="email" name="asst3_email" placeholder="Email (optional)" /></td>
                      <td><input type="tel" name="asst3_phone" placeholder="Phone (optional)" inputmode="tel" /></td>
                    </tr>
                    <tr class="staff-row">
                      <td>21</td>
                      <td><strong>GM</strong></td>
                      <td><input type="text" name="gm_first" placeholder="First name (optional)" /></td>
                      <td><input type="text" name="gm_last" placeholder="Last name (optional)" /></td>
                      <td>-</td>
                      <td><input type="email" name="gm_email" placeholder="Email (optional)" /></td>
                      <td><input type="tel" name="gm_phone" placeholder="Phone (optional)" inputmode="tel" /></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>
        </div>
      </div>

      <!-- Step 4: Review -->
      <div class="form-step" data-step="4">
        <section class="form-section">
          <h2>üìã Review Your Submission</h2>
          <div id="reviewContent"></div>
        </section>
      </div>

      <!-- Navigation Buttons -->
      <div class="step-navigation">
        <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">‚Üê Previous</button>
        <div class="buttons">
          <button type="button" class="btn btn-secondary" id="clearBtn">üóëÔ∏è Clear All</button>
          <button type="button" class="btn btn-outline" id="saveBtn">üíæ Save Draft</button>
          <button type="button" class="btn btn-outline" id="restoreBtn">‚Ü© Restore Draft</button>
          <button type="button" class="btn btn-success" id="newBtn" style="display:none">üìã New Submission</button>
        </div>
        <button type="button" class="btn btn-primary" id="nextBtn">Next ‚Üí</button>
        <button type="submit" class="btn btn-primary" id="submitBtn" style="display: none;">üöÄ Submit All Teams</button>
      </div>

      <div id="loading" class="loading">üîÑ Submitting your club rosters...</div>
      <div id="okMsg" class="status status--ok" role="status" aria-live="polite">‚úÖ All team rosters submitted successfully!</div>
    </form>
  </div>

  <script>
    // === Configuration ===
    const EmailJSConfig = Object.freeze({
      publicKey: "_r4Y7hg0AGi5DhIcF",
      serviceId: "service_4bdvcf9",
      templateId: "template_6o8secn"
    });

    const DATA_SINK_URL = 'https://script.google.com/macros/s/AKfycbxchgyxazvH9t4N0prpLTboqeAlb6kRz6xUj-klQ1HIYtrZjs9qeKxWVqTttVJKdREj/exec';
    const DATA_SINK_KEY = 'Pixellot2@25';

    const APP_VERSION = '5.4.0 - ENHANCED';
    const BUILD_DATE = new Date().toISOString().slice(0,10);

    const CURRENT_SEASON_START_YEAR = 2025;
    const NEXT_SEASON_START_YEAR = 2026;
    const SWITCHOVER_DATE = new Date(2026, 7, 1);
    const FORCE_EXPOSE_NEXT_SEASON = false;

    const DEFAULT_PLAYER_ROWS = 16;
    const HARD_MAX_PLAYERS = 40;
    const STORAGE_KEY = "ibbaMultiTeamDraft_v540";

    // === Enhanced Email Validation & Typo Correction ===
    function emailValid(email) {
      const e = (email || '').trim().toLowerCase();
      if (!e) return { ok: true };
      
      // Basic format check
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)) return { ok: false };
      
      // Check for invalid patterns
      if (e.includes('..')) return { ok: false }; // Double dots anywhere
      if (e.includes('@.') || e.includes('.@')) return { ok: false }; // Dots adjacent to @
      if (e.startsWith('.') || e.endsWith('.')) return { ok: false }; // Starts or ends with dot
      if (e.includes('@-') || e.includes('-@')) return { ok: false }; // Hyphens adjacent to @
      
      // Split and validate parts
      const parts = e.split('@');
      if (parts.length !== 2) return { ok: false };
      
      const [localPart, domainPart] = parts;
      if (!localPart || !domainPart) return { ok: false };
      
      // Validate domain part has proper TLD
      const domainParts = domainPart.split('.');
      if (domainParts.length < 2) return { ok: false };
      
      // Check for empty parts in domain
      for (let i = 0; i < domainParts.length; i++) {
        if (!domainParts[i] || domainParts[i].length === 0) return { ok: false };
      }
      
      // TLD should be at least 2 characters
      const tld = domainParts[domainParts.length - 1];
      if (tld.length < 2) return { ok: false };
      
      // Common typo corrections
      const typoMap = {
        '.con': '.com', '.cmo': '.com', '.ocm': '.com', '.cpm': '.com',
        '@gamil.': '@gmail.', '@gmial.': '@gmail.', '@gmai.': '@gmail.',
        '@yahooo.': '@yahoo.', '@hotmial.': '@hotmail.', '@outlok.': '@outlook.'
      };
      
      for (const k in typoMap) {
        if (e.includes(k)) return { ok: false, suggestion: e.replace(k, typoMap[k]) };
      }
      
      return { ok: true };
    }

    function formatEmail(email) {
      if (!email) return '';
      return email.trim().toLowerCase();
    }

    // === Inline Error Helpers ===
    function showFieldError(inputEl, msg, errorElId) {
      const box = document.getElementById(errorElId);
      if (box) {
        box.textContent = msg;
        box.style.display = 'block';
      }
      if (inputEl) {
        inputEl.classList.add('input-error');
        inputEl.setAttribute('aria-invalid', 'true');
      }
    }

    function clearFieldError(inputEl, errorElId) {
      const box = document.getElementById(errorElId);
      if (box) {
        box.textContent = '';
        box.style.display = 'none';
      }
      if (inputEl) {
        inputEl.classList.remove('input-error');
        inputEl.removeAttribute('aria-invalid');
      }
    }

    // === Data Structure ===
    let clubData = {
      clubName: '',
      season: '',
      submitterName: '',
      submitterEmail: '',
      teams: [] // { id, nickname, ageGroup, league, players: [], staff: [] }
    };

    let currentStep = 1;
    let totalSteps = 4;
    let activeTeamId = null;
    let teamIdCounter = 1;

    // === Enhanced Utility Functions ===
    function clean(s) { 
      return (s ?? '').toString().trim(); 
    }

    function ucWords(str="") { 
      return str.toLowerCase().replace(/\b\w/g, ch => ch.toUpperCase()); 
    }
    
    function properCase(str="") {
      // Split by spaces and process each word
      return str.split(' ').map(word => {
        // Handle empty strings
        if (!word) return word;
        
        // Check for all caps (like "URI") - convert to proper case
        if (word === word.toUpperCase() && word.length > 1) {
          return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        }
        
        // Check for mixed case (like "RoIZ") - convert to proper case
        const hasLowerCase = /[a-z]/.test(word);
        const hasUpperCase = /[A-Z]/.test(word);
        if (hasLowerCase && hasUpperCase) {
          return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        }
        
        // Already properly formatted
        if (word.charAt(0) === word.charAt(0).toUpperCase() && 
            word.slice(1) === word.slice(1).toLowerCase()) {
          return word;
        }
        
        // Default: capitalize first letter, lowercase the rest
        return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
      }).join(' ');
    }

    function ucName(s) { 
      return properCase(clean(s)); 
    }

    // === Enhanced Height Validation ===
    function normHeight(val) {
      const h = parseInt(String(val).trim(), 10);
      if (!Number.isFinite(h)) return '';
      if (h < 100 || h > 272) return '';
      return String(h);
    }

    function validateHeightInput(input) {
      const value = input.value.trim();
      if (!value) return true; // Empty is OK
      
      const height = parseInt(value, 10);
      if (isNaN(height) || height < 100 || height > 272) {
        input.classList.add('input-error');
        input.setAttribute('aria-invalid', 'true');
        return false;
      } else {
        input.classList.remove('input-error');
        input.removeAttribute('aria-invalid');
        return true;
      }
    }

    // Hook height validation listeners
    function hookHeightValidationListeners() {
      document.querySelectorAll('input[name*="_height"]').forEach(input => {
        input.removeEventListener('input', handleHeightInput);
        input.addEventListener('input', handleHeightInput);
        
        input.removeEventListener('blur', handleHeightBlur);
        input.addEventListener('blur', handleHeightBlur);
      });
    }

    function handleHeightInput(e) {
      // Allow typing but remove error styling
      e.target.classList.remove('input-error');
      e.target.removeAttribute('aria-invalid');
    }

    function handleHeightBlur(e) {
      if (validateHeightInput(e.target)) {
        saveCurrentTeamRoster();
      }
    }

    function leagueToEnglish(h) {
      const map = {
        '◊®◊í◊ô◊ú': 'Regular',
        '◊û◊ó◊ï◊ñ◊ô◊™': 'Regional',
        '◊ê◊®◊¶◊ô◊™': 'National',
        '◊ú◊ê◊ï◊û◊ô◊™': '2nd Division',
        '◊¢◊ú': '1st Division'
      };
      return map[h] || 'Unknown League';
    }

    function ageGroupToEnglish(h) {
      const map = {
        '◊ß◊ò-◊°◊ú ◊ë': 'U11',
        '◊ß◊ò-◊°◊ú ◊ê': 'U12', 
        '◊ô◊ú◊ì◊ô◊ù ◊ë': 'U13 Boys',
        '◊ô◊ú◊ì◊ï◊™ ◊ë': 'U13 Girls',
        '◊ô◊ú◊ì◊ô◊ù ◊ê': 'U14 Boys',
        '◊ô◊ú◊ì◊ï◊™ ◊ê': 'U14 Girls',
        '◊†◊¢◊®◊ô◊ù ◊ë': 'U15 Boys',
        '◊†◊¢◊®◊ï◊™ ◊ë': 'U16 Girls',
        '◊†◊¢◊®◊ô◊ù ◊ê': 'U16 Boys',
        '◊†◊¢◊®◊ï◊™ ◊ê': 'U18 Girls',
        '◊†◊ï◊¢◊®': 'U18 Boys',
        '◊ë◊ï◊í◊®◊ô◊ù': 'Adults Men',
        '◊ë◊ï◊í◊®◊ï◊™': 'Adults Women'
      };
      return map[h] || 'Unknown Age Group';
    }

    function positionToFullName(pos) {
      const map = { 'G': 'Guard', 'F': 'Forward', 'C': 'Center' };
      return map[pos] || pos;
    }

    function seasonLabel(fromYear) {
      const toYear = (fromYear + 1).toString().slice(-2);
      return `${fromYear}/${toYear}`;
    }

    function populateSeasonSelect() {
      const sel = document.getElementById('season');
      if (!sel) return;
      
      sel.innerHTML = '';
      const seasons = [CURRENT_SEASON_START_YEAR];
      const exposeNext = FORCE_EXPOSE_NEXT_SEASON || (new Date() >= SWITCHOVER_DATE);
      if (exposeNext) seasons.push(NEXT_SEASON_START_YEAR);
      
      for (const y of seasons) {
        const opt = document.createElement('option');
        opt.value = `${y}-${y + 1}`;
        opt.textContent = seasonLabel(y);
        sel.appendChild(opt);
      }
      
      // Set default value
      const defaultYear = exposeNext ? NEXT_SEASON_START_YEAR : CURRENT_SEASON_START_YEAR;
      sel.value = `${defaultYear}-${defaultYear + 1}`;
    }

    // === Enhanced Multi-Step Navigation ===
    function updateProgress() {
      const progress = (currentStep / totalSteps) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      
      document.querySelectorAll('.step').forEach((step, index) => {
        const stepNum = index + 1;
        step.classList.remove('active', 'completed', 'pending');
        
        if (stepNum < currentStep) {
          step.classList.add('completed');
          step.querySelector('.step-circle').textContent = '‚úì';
        } else if (stepNum === currentStep) {
          step.classList.add('active');
          step.querySelector('.step-circle').textContent = stepNum;
        } else {
          step.classList.add('pending');
          step.querySelector('.step-circle').textContent = stepNum;
        }
      });
    }

    function showStep(step) {
      document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));
      document.querySelector(`.form-step[data-step="${step}"]`).classList.add('active');
      
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      
      prevBtn.style.display = step > 1 ? 'block' : 'none';
      nextBtn.style.display = step < totalSteps ? 'block' : 'none';
      submitBtn.style.display = step === totalSteps ? 'block' : 'none';
      
      updateNextButtonState();
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      if (step === 3) {
        updateRosterView();
      } else if (step === 4) {
        updateReviewContent();
      }
    }

    function updateNextButtonState() {
      const nextBtn = document.getElementById('nextBtn');
      if (!nextBtn || nextBtn.style.display === 'none') return;
      
      let canProceed = false;
      let reasonText = '';
      
      if (currentStep === 1) {
        const clubName = document.getElementById('clubName').value.trim();
        const season = document.getElementById('season').value;
        const submitterName = document.getElementById('submitterName').value.trim();
        const submitterEmail = document.getElementById('submitterEmail').value.trim();
        
        const hasAllFields = clubName && season && submitterName && submitterEmail;
        const emailResult = emailValid(submitterEmail);
        
        canProceed = hasAllFields && emailResult.ok;
        
        if (!clubName) reasonText = 'Enter club name';
        else if (!season) reasonText = 'Select season';
        else if (!submitterName) reasonText = 'Enter your name';
        else if (!submitterEmail) reasonText = 'Enter your email';
        else if (!emailResult.ok) reasonText = 'Enter valid email';
        
      } else if (currentStep === 2) {
        const hasTeams = clubData.teams.length > 0;
        const allTeamsComplete = clubData.teams.every(team => isTeamComplete(team));
        
        canProceed = hasTeams && allTeamsComplete;
        
        if (!hasTeams) {
          reasonText = 'Add at least one team';
        } else if (!allTeamsComplete) {
          const incompleteCount = clubData.teams.filter(t => !isTeamComplete(t)).length;
          reasonText = `Complete age group and league for ${incompleteCount} team(s)`;
        }
      } else if (currentStep === 3) {
        if (activeTeamId) {
          saveCurrentTeamRoster();
        }
        
        const incompleteTeams = [];
        clubData.teams.forEach(team => {
          const hasPlayers = team.players?.some(p => p.jersey && p.first && p.last && p.position) || false;
          const hasStaff = team.staff?.some(s => s.first && s.last) || false;
          
          if (!hasPlayers || !hasStaff) {
            incompleteTeams.push(team);
          }
        });
        
        canProceed = incompleteTeams.length === 0;
        
        if (!canProceed) {
          reasonText = `${incompleteTeams.length} team(s) need players and staff`;
        }
      }
      
      if (canProceed) {
        nextBtn.disabled = false;
        nextBtn.textContent = 'Next ‚Üí';
        nextBtn.style.opacity = '1';
        nextBtn.style.cursor = 'pointer';
        nextBtn.title = '';
        nextBtn.classList.remove('btn-outline');
        nextBtn.classList.add('btn-primary');
      } else {
        nextBtn.disabled = true;
        nextBtn.textContent = reasonText ? `Next ‚Üí (${reasonText})` : 'Next ‚Üí';
        nextBtn.style.opacity = '0.6';
        nextBtn.style.cursor = 'not-allowed';
        nextBtn.title = reasonText;
        nextBtn.classList.remove('btn-primary');
        nextBtn.classList.add('btn-outline');
      }
    }

    // === Enhanced Form Validation ===
    function validateCurrentStep() {
      if (currentStep === 1) {
        const clubNameField = document.getElementById('clubName');
        const seasonField = document.getElementById('season');
        const submitterNameField = document.getElementById('submitterName');
        const submitterEmailField = document.getElementById('submitterEmail');
        
        // Clear previous errors
        clearFieldError(clubNameField, 'clubNameError');
        clearFieldError(seasonField, 'seasonError');
        clearFieldError(submitterNameField, 'submitterNameError');
        clearFieldError(submitterEmailField, 'submitterEmailError');
        
        // Validate required fields
        if (!clubNameField.value.trim()) {
          showFieldError(clubNameField, 'Club name is required.', 'clubNameError');
          clubNameField.focus();
          return false;
        }
        
        if (!seasonField.value) {
          showFieldError(seasonField, 'Season selection is required.', 'seasonError');
          seasonField.focus();
          return false;
        }
        
        if (!submitterNameField.value.trim()) {
          showFieldError(submitterNameField, 'Your name is required.', 'submitterNameError');
          submitterNameField.focus();
          return false;
        }
        
        if (!submitterEmailField.value.trim()) {
          showFieldError(submitterEmailField, 'Your email is required.', 'submitterEmailError');
          submitterEmailField.focus();
          return false;
        }
        
        // Enhanced email validation with typo correction
        const emailResult = emailValid(submitterEmailField.value);
        if (!emailResult.ok && emailResult.suggestion) {
          const useCorrection = confirm(`Email typo detected!\n\nDid you mean: ${emailResult.suggestion}?`);
          if (useCorrection) {
            submitterEmailField.value = emailResult.suggestion;
          } else {
            showFieldError(submitterEmailField, `Please correct your email. Suggested: ${emailResult.suggestion}`, 'submitterEmailError');
            submitterEmailField.focus();
            return false;
          }
        } else if (!emailResult.ok) {
          showFieldError(submitterEmailField, 'Please enter a valid email address.', 'submitterEmailError');
          submitterEmailField.focus();
          return false;
        }
        
        saveClubInfo();
      } else if (currentStep === 2) {
        if (clubData.teams.length === 0) {
          alert('Please add at least one team before proceeding.');
          return false;
        }
        
        const incompleteTeams = clubData.teams.filter(team => !isTeamComplete(team));
        if (incompleteTeams.length > 0) {
          alert('Please complete all team information (age group and league are required) before proceeding.');
          return false;
        }
      } else if (currentStep === 3) {
        if (activeTeamId) {
          saveCurrentTeamRoster();
        }
        
        // Enhanced roster validation
        const validationResults = validateAllTeamRosters();
        if (!validationResults.valid) {
          alert(validationResults.message);
          return false;
        }
      }
      
      return true;
    }

    function validateAllTeamRosters() {
      for (const team of clubData.teams) {
        const teamName = getFullTeamName(team);
        
        // Check for at least one complete player
        const completePlayers = team.players?.filter(p => p.jersey && p.first && p.last && p.position) || [];
        if (completePlayers.length === 0) {
          return {
            valid: false,
            message: `${teamName} needs at least one complete player (jersey, first name, last name, position are required).`
          };
        }
        
        // Check for player completeness
        const playerValidation = validatePlayersCompleteness(team);
        if (playerValidation) {
          return {
            valid: false,
            message: `${teamName}: ${playerValidation}`
          };
        }
        
        // Check for duplicate jerseys
        const jerseys = team.players?.map(p => normJersey(p.jersey)).filter(Boolean) || [];
        const duplicates = jerseys.filter((jersey, index) => jerseys.indexOf(jersey) !== index);
        if (duplicates.length > 0) {
          return {
            valid: false,
            message: `${teamName} has duplicate jersey numbers: ${duplicates.join(', ')}`
          };
        }
        
        // Check head coach
        const headCoachValidation = validateHeadCoach(team);
        if (headCoachValidation) {
          return {
            valid: false,
            message: `${teamName}: ${headCoachValidation}`
          };
        }
        
        // Check staff completeness
        const staffValidation = validateStaffCompleteness(team);
        if (staffValidation) {
          return {
            valid: false,
            message: `${teamName}: ${staffValidation}`
          };
        }
        
        // Validate all email addresses
        const emailValidation = validateAllEmails(team);
        if (emailValidation) {
          return {
            valid: false,
            message: `${teamName}: ${emailValidation}`
          };
        }
      }
      
      return { valid: true };
    }

    function validatePlayersCompleteness(team) {
      const players = team.players || [];
      for (let i = 0; i < players.length; i++) {
        const player = players[i];
        const hasAny = player.jersey || player.first || player.last || player.position || player.email || player.height;
        
        if (hasAny) {
          if (!normJersey(player.jersey)) return `Player ${i + 1} is missing jersey number`;
          if (!player.first?.trim()) return `Player ${i + 1} is missing first name`;
          if (!player.last?.trim()) return `Player ${i + 1} is missing last name`;
          if (!player.position) return `Player ${i + 1} is missing position`;
          
          // Validate height if provided
          if (player.height) {
            const height = parseInt(player.height, 10);
            if (isNaN(height) || height < 100 || height > 272) {
              return `Player ${i + 1} has invalid height (must be between 100-272 cm)`;
            }
          }
        }
      }
      return null;
    }

    function validateHeadCoach(team) {
      const staff = team.staff || [];
      const headCoach = staff[0]; // Head coach is always first
      
      if (!headCoach) return 'Head coach information is required';
      if (!headCoach.first?.trim()) return 'Head coach first name is required';
      if (!headCoach.last?.trim()) return 'Head coach last name is required';
      if (!headCoach.email?.trim()) return 'Head coach email is required';
      if (!headCoach.phone?.trim()) return 'Head coach phone is required';
      
      return null;
    }

    function validateStaffCompleteness(team) {
      const staff = team.staff || [];
      const roles = ['Assistant Coach 1', 'Assistant Coach 2', 'Assistant Coach 3', 'General Manager'];
      
      for (let i = 1; i < staff.length; i++) { // Skip head coach (index 0)
        const staffMember = staff[i];
        const roleName = roles[i - 1] || `Staff member ${i + 1}`;
        
        const hasAny = staffMember.first || staffMember.last || staffMember.email || staffMember.phone;
        const hasAll = staffMember.first?.trim() && staffMember.last?.trim() && 
                      staffMember.email?.trim() && staffMember.phone?.trim();
        
        if (hasAny && !hasAll) {
          return `${roleName} information is incomplete. All fields (first name, last name, email, phone) are required if any are filled.`;
        }
      }
      
      return null;
    }

    function validateAllEmails(team) {
      // Check player emails
      const players = team.players || [];
      for (let i = 0; i < players.length; i++) {
        const email = players[i].email?.trim();
        if (email) {
          const result = emailValid(email);
          if (!result.ok) {
            return `Player ${i + 1} has invalid email address`;
          }
        }
      }
      
      // Check staff emails
      const staff = team.staff || [];
      const roleNames = ['Head Coach', 'Assistant Coach 1', 'Assistant Coach 2', 'Assistant Coach 3', 'General Manager'];
      
      for (let i = 0; i < staff.length; i++) {
        const email = staff[i].email?.trim();
        if (email) {
          const result = emailValid(email);
          if (!result.ok) {
            return `${roleNames[i] || 'Staff member'} has invalid email address`;
          }
        }
      }
      
      return null;
    }

    function nextStep() {
      if (!validateCurrentStep()) return;
      
      if (currentStep < totalSteps) {
        currentStep++;
        showStep(currentStep);
        updateProgress();
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
        updateProgress();
      }
    }

    // === Club Info Management ===
    function saveClubInfo() {
      clubData.clubName = properCase(document.getElementById('clubName').value.trim());
      clubData.season = document.getElementById('season').value;
      clubData.submitterName = properCase(document.getElementById('submitterName').value.trim());
      clubData.submitterEmail = formatEmail(document.getElementById('submitterEmail').value.trim());
    }

    // === Team Management ===
    function getFullTeamName(team) {
      const ageGroupEnglish = ageGroupToEnglish(team.ageGroup);
      if (team.nickname && team.nickname.trim()) {
        return `${clubData.clubName} ${team.nickname} (${ageGroupEnglish})`.trim();
      } else {
        return `${clubData.clubName} ${ageGroupEnglish}`.trim();
      }
    }

    function addTeam() {
      const team = {
        id: teamIdCounter++,
        nickname: '',
        ageGroup: '',
        league: '',
        players: [],
        staff: []
      };
      clubData.teams.push(team);
      renderTeams();
    }

    function removeTeam(teamId) {
      if (!confirm('Remove this team and all its roster data?')) return;
      clubData.teams = clubData.teams.filter(t => t.id !== teamId);
      if (activeTeamId === teamId) {
        activeTeamId = null;
      }
      renderTeams();
      updateRosterView();
    }

    function updateTeam(teamId, field, value) {
      const team = clubData.teams.find(t => t.id === teamId);
      if (team) {
        if (field === 'nickname') {
          value = formatTeamNickname(value);
        }
        team[field] = value;
        
        updateTeamStatus(teamId);
        updateNextButtonState();
      }
    }

    function formatTeamNickname(nickname) {
      if (!nickname) return nickname;
      
      const hasHebrew = /[\u0590-\u05FF]/.test(nickname);
      
      if (hasHebrew) {
        return nickname;
      } else {
        return ucWords(nickname.trim());
      }
    }

    function isTeamComplete(team) {
      return team.ageGroup && team.league;
    }

    function getTeamStatus(team) {
      if (!team.ageGroup || !team.league) return 'incomplete';
      return 'complete';
    }

    function updateTeamStatus(teamId) {
      const team = clubData.teams.find(t => t.id === teamId);
      if (!team) return;
      
      const status = getTeamStatus(team);
      const statusText = status === 'complete' ? 'Complete' : 'Incomplete';
      
      const teamCards = document.querySelectorAll('.team-card');
      teamCards.forEach(card => {
        const titleElement = card.querySelector('.team-title');
        if (titleElement && titleElement.textContent === `Team ${teamId}`) {
          const statusElement = card.querySelector('.team-status');
          if (statusElement) {
            statusElement.className = `team-status ${status}`;
            statusElement.textContent = statusText;
          }
          card.className = `team-card ${status}`;
        }
      });
    }

    function updateLeagueOptions(ageGroup, selectElement) {
      selectElement.innerHTML = '<option value="">Select League</option>';
      
      const noLeagueAgeGroups = ['◊ß◊ò-◊°◊ú ◊ë', '◊ß◊ò-◊°◊ú ◊ê', '◊ô◊ú◊ì◊ô◊ù ◊ë', '◊ô◊ú◊ì◊ï◊™ ◊ë'];
      
      if (noLeagueAgeGroups.includes(ageGroup)) {
        const option = document.createElement('option');
        option.value = '◊®◊í◊ô◊ú';
        option.textContent = '◊®◊í◊ô◊ú';
        selectElement.appendChild(option);
        selectElement.value = '◊®◊í◊ô◊ú';
        selectElement.disabled = true;
        return '◊®◊í◊ô◊ú';
      } else if (ageGroup) {
        const leagues = [
          { value: '◊û◊ó◊ï◊ñ◊ô◊™', text: '◊û◊ó◊ï◊ñ◊ô◊™' },
          { value: '◊ê◊®◊¶◊ô◊™', text: '◊ê◊®◊¶◊ô◊™' },
          { value: '◊ú◊ê◊ï◊û◊ô◊™', text: '◊ú◊ê◊ï◊û◊ô◊™' },
          { value: '◊¢◊ú', text: '◊¢◊ú' }
        ];
        
        leagues.forEach(league => {
          const option = document.createElement('option');
          option.value = league.value;
          option.textContent = league.text;
          selectElement.appendChild(option);
        });
        
        selectElement.disabled = false;
      } else {
        selectElement.disabled = false;
      }
      
      return null;
    }

    function renderTeams() {
      const container = document.getElementById('teamsContainer');
      container.innerHTML = '';
      
      clubData.teams.forEach(team => {
        const status = getTeamStatus(team);
        const statusText = status === 'complete' ? 'Complete' : 'Incomplete';
        
        const teamCard = document.createElement('div');
        teamCard.className = `team-card ${status}`;
        teamCard.innerHTML = `
          <div class="team-header">
            <div class="team-title">Team ${team.id}</div>
            <div class="team-status ${status}">${statusText}</div>
          </div>
          <div class="team-info">
            <div>
              <label class="tooltip">Team Nickname
                <span class="tooltiptext">Optional: Add a team nickname like "EAGLES" or coach name. If left empty, team will be called by age group only.</span>
              </label>
              <input type="text" value="${team.nickname}" placeholder="e.g., EAGLES, COACH_SMITH (optional)" 
                     onchange="updateTeam(${team.id}, 'nickname', this.value)" 
                     oninput="updateTeam(${team.id}, 'nickname', this.value)" />
            </div>
            <div>
              <label class="required tooltip">Age Group
                <span class="tooltiptext">Required: Select the age category for this team (e.g., U16 Boys, U13 Girls, Adults)</span>
              </label>
              <select onchange="updateTeam(${team.id}, 'ageGroup', this.value); updateLeagueForTeam(${team.id}, this.value)">
                <option value="">Select Age Group</option>
                <option value="◊ß◊ò-◊°◊ú ◊ë" ${team.ageGroup === '◊ß◊ò-◊°◊ú ◊ë' ? 'selected' : ''}>◊ß◊ò-◊°◊ú ◊ë (U11)</option>
                <option value="◊ß◊ò-◊°◊ú ◊ê" ${team.ageGroup === '◊ß◊ò-◊°◊ú ◊ê' ? 'selected' : ''}>◊ß◊ò-◊°◊ú ◊ê (U12)</option>
                <option value="◊ô◊ú◊ì◊ô◊ù ◊ë" ${team.ageGroup === '◊ô◊ú◊ì◊ô◊ù ◊ë' ? 'selected' : ''}>◊ô◊ú◊ì◊ô◊ù ◊ë (U13 Boys)</option>
                <option value="◊ô◊ú◊ì◊ï◊™ ◊ë" ${team.ageGroup === '◊ô◊ú◊ì◊ï◊™ ◊ë' ? 'selected' : ''}>◊ô◊ú◊ì◊ï◊™ ◊ë (U13 Girls)</option>
                <option value="◊ô◊ú◊ì◊ô◊ù ◊ê" ${team.ageGroup === '◊ô◊ú◊ì◊ô◊ù ◊ê' ? 'selected' : ''}>◊ô◊ú◊ì◊ô◊ù ◊ê (U14 Boys)</option>
                <option value="◊ô◊ú◊ì◊ï◊™ ◊ê" ${team.ageGroup === '◊ô◊ú◊ì◊ï◊™ ◊ê' ? 'selected' : ''}>◊ô◊ú◊ì◊ï◊™ ◊ê (U14 Girls)</option>
                <option value="◊†◊¢◊®◊ô◊ù ◊ë" ${team.ageGroup === '◊†◊¢◊®◊ô◊ù ◊ë' ? 'selected' : ''}>◊†◊¢◊®◊ô◊ù ◊ë (U15 Boys)</option>
                <option value="◊†◊¢◊®◊ï◊™ ◊ë" ${team.ageGroup === '◊†◊¢◊®◊ï◊™ ◊ë' ? 'selected' : ''}>◊†◊¢◊®◊ï◊™ ◊ë (U16 Girls)</option>
                <option value="◊†◊¢◊®◊ô◊ù ◊ê" ${team.ageGroup === '◊†◊¢◊®◊ô◊ù ◊ê' ? 'selected' : ''}>◊†◊¢◊®◊ô◊ù ◊ê (U16 Boys)</option>
                <option value="◊†◊¢◊®◊ï◊™ ◊ê" ${team.ageGroup === '◊†◊¢◊®◊ï◊™ ◊ê' ? 'selected' : ''}>◊†◊¢◊®◊ï◊™ ◊ê (U18 Girls)</option>
                <option value="◊†◊ï◊¢◊®" ${team.ageGroup === '◊†◊ï◊¢◊®' ? 'selected' : ''}>◊†◊ï◊¢◊® (U18 Boys)</option>
                <option value="◊ë◊ï◊í◊®◊ô◊ù" ${team.ageGroup === '◊ë◊ï◊í◊®◊ô◊ù' ? 'selected' : ''}>◊ë◊ï◊í◊®◊ô◊ù (Adults Men)</option>
                <option value="◊ë◊ï◊í◊®◊ï◊™" ${team.ageGroup === '◊ë◊ï◊í◊®◊ï◊™' ? 'selected' : ''}>◊ë◊ï◊í◊®◊ï◊™ (Adults Women)</option>
              </select>
            </div>
            <div>
              <label class="required tooltip">League
                <span class="tooltiptext">Required: Select the competition level. Some age groups automatically assign "Regular" league.</span>
              </label>
              <select id="league_${team.id}" onchange="updateTeam(${team.id}, 'league', this.value)">
                <option value="">Select League</option>
              </select>
            </div>
            <div>
              <button class="remove-team" onclick="removeTeam(${team.id})">üóëÔ∏è Remove</button>
            </div>
          </div>
        `;
        container.appendChild(teamCard);
        
        const leagueSelect = teamCard.querySelector(`#league_${team.id}`);
        const autoSelectedLeague = updateLeagueOptions(team.ageGroup, leagueSelect);
        
        if (autoSelectedLeague && !team.league) {
          team.league = autoSelectedLeague;
        }
        
        if (team.league) {
          leagueSelect.value = team.league;
        }
      });
      
      updateNextButtonState();
    }

    function updateLeagueForTeam(teamId, ageGroup) {
      const team = clubData.teams.find(t => t.id === teamId);
      if (!team) return;
      
      const leagueSelect = document.querySelector(`#league_${teamId}`);
      if (!leagueSelect) return;
      
      team.league = '';
      
      const autoSelectedLeague = updateLeagueOptions(ageGroup, leagueSelect);
      
      if (autoSelectedLeague) {
        team.league = autoSelectedLeague;
      }
      
      updateTeamStatus(teamId);
      updateNextButtonState();
    }

    // === Roster Management ===
    function updateRosterView() {
      const noTeamsMsg = document.getElementById('noTeamsMessage');
      const rosterMgmt = document.getElementById('rosterManagement');
      
      if (clubData.teams.length === 0) {
        noTeamsMsg.style.display = 'block';
        rosterMgmt.style.display = 'none';
        return;
      }
      
      noTeamsMsg.style.display = 'none';
      rosterMgmt.style.display = 'block';
      
      renderTeamTabs();
      
      if (!activeTeamId && clubData.teams.length > 0) {
        activeTeamId = clubData.teams[0].id;
      }
      
      if (activeTeamId) {
        showTeamRoster(activeTeamId);
      }
    }

    function renderTeamTabs() {
      const tabsContainer = document.getElementById('teamTabs');
      tabsContainer.innerHTML = '';
      
      clubData.teams.forEach(team => {
        const fullName = getFullTeamName(team);
        const hasRoster = hasCompleteRoster(team);
        
        const tab = document.createElement('div');
        tab.className = `team-tab ${activeTeamId === team.id ? 'active' : ''} ${hasRoster ? 'complete' : ''}`;
        tab.textContent = fullName || `Team ${team.id}`;
        tab.onclick = () => showTeamRoster(team.id);
        tabsContainer.appendChild(tab);
      });
    }

    function hasCompleteRoster(team) {
      const hasPlayers = team.players?.some(p => p.jersey && p.first && p.last && p.position) || false;
      const hasStaff = team.staff?.some(s => s.first && s.last) || false;
      return hasPlayers && hasStaff;
    }

    function showTeamRoster(teamId) {
      activeTeamId = teamId;
      const team = clubData.teams.find(t => t.id === teamId);
      if (!team) return;
      
      document.querySelectorAll('.team-tab').forEach((tab, idx) => {
        tab.classList.toggle('active', idx === clubData.teams.findIndex(t => t.id === teamId));
      });
      
      document.getElementById('activeRosterSection').style.display = 'block';
      
      loadTeamRoster(team);
    }

    function loadTeamRoster(team) {
      if (!team.players) team.players = [];
      if (!team.staff) team.staff = [];
      
      ensurePlayersRows(Math.max(DEFAULT_PLAYER_ROWS, team.players.length));
      
      team.players.forEach((player, idx) => {
        const rowIdx = idx + 1;
        const fields = ['jersey', 'first', 'last', 'height', 'position', 'email'];
        fields.forEach(field => {
          const input = document.querySelector(`input[name="player${rowIdx}_${field}"], select[name="player${rowIdx}_${field}"]`);
          if (input && player[field] !== undefined) {
            input.value = player[field];
          }
        });
      });
      
      const staffRoles = ['coach', 'asst1', 'asst2', 'asst3', 'gm'];
      staffRoles.forEach(role => {
        const fields = ['first', 'last', 'email', 'phone'];
        fields.forEach(field => {
          const input = document.querySelector(`input[name="${role}_${field}"]`);
          if (input) {
            input.value = '';
          }
        });
      });
      
      team.staff.forEach((staffMember, idx) => {
        if (idx < staffRoles.length) {
          const role = staffRoles[idx];
          const fields = ['first', 'last', 'email', 'phone'];
          fields.forEach(field => {
            const input = document.querySelector(`input[name="${role}_${field}"]`);
            if (input && staffMember[field] !== undefined) {
              input.value = staffMember[field];
            }
          });
        }
      });
      
      // Auto-apply GM from first team to other teams
      if (team.id > 1 && clubData.teams.length > 1) {
        const firstTeam = clubData.teams.find(t => t.id === 1);
        if (firstTeam && firstTeam.staff && firstTeam.staff.length >= 5) {
          const gmData = firstTeam.staff[4];
          if (gmData && (gmData.first || gmData.last)) {
            const gmFields = ['first', 'last', 'email', 'phone'];
            gmFields.forEach(field => {
              const input = document.querySelector(`input[name="gm_${field}"]`);
              if (input && gmData[field]) {
                input.value = gmData[field];
              }
            });
          }
        }
      }
      
      checkDuplicates();
      bumpRowCount();
    }

    function normJersey(val) {
      const n = parseInt(String(val).trim(), 10);
      return Number.isFinite(n) ? String(n) : '';
    }

    function saveCurrentTeamRoster() {
      if (!activeTeamId) return;
      
      const team = clubData.teams.find(t => t.id === activeTeamId);
      if (!team) return;
      
      // Save players with enhanced data processing
      team.players = [];
      const rows = document.querySelectorAll('#playersTable tr').length;
      for (let i = 1; i <= rows; i++) {
        const jersey = normJersey(document.querySelector(`input[name="player${i}_jersey"]`)?.value || '');
        const first = ucName(document.querySelector(`input[name="player${i}_first"]`)?.value || '');
        const last = ucName(document.querySelector(`input[name="player${i}_last"]`)?.value || '');
        const height = normHeight(document.querySelector(`input[name="player${i}_height"]`)?.value || '');
        const position = document.querySelector(`select[name="player${i}_position"]`)?.value || '';
        const email = formatEmail(document.querySelector(`input[name="player${i}_email"]`)?.value || '');
        
        if (jersey || first || last || height || position || email) {
          team.players.push({
            jersey: jersey,
            first: first,
            last: last,
            height: height,
            position: position,
            email: email
          });
        }
      }
      
      // Sort players by jersey number
      team.players.sort((a, b) => {
        const aNum = parseInt(a.jersey, 10);
        const bNum = parseInt(b.jersey, 10);
        return aNum - bNum;
      });
      
      // Save staff with enhanced data processing
      team.staff = [];
      const staffRoles = [
        { key: 'coach', label: 'Head Coach' },
        { key: 'asst1', label: 'Assistant Coach 1' },
        { key: 'asst2', label: 'Assistant Coach 2' },
        { key: 'asst3', label: 'Assistant Coach 3' },
        { key: 'gm', label: 'General Manager' }
      ];
      
      staffRoles.forEach(role => {
        const first = ucName(document.querySelector(`input[name="${role.key}_first"]`)?.value || '');
        const last = ucName(document.querySelector(`input[name="${role.key}_last"]`)?.value || '');
        const email = formatEmail(document.querySelector(`input[name="${role.key}_email"]`)?.value || '');
        const phone = clean(document.querySelector(`input[name="${role.key}_phone"]`)?.value || '');
        
        if (first || last || email || phone) {
          team.staff.push({
            role: role.label,
            first: first,
            last: last,
            email: email,
            phone: phone
          });
        }
      });
      
      renderTeamTabs();
    }

    // === Enhanced Players Table Management ===
    function playerRowTemplate(idx) {
      const sn = String(idx).padStart(2, '0');
      return `
        <tr data-player-row="${idx}">
          <td><input type="checkbox" class="player-select" data-player="${idx}" /></td>
          <td><strong>${sn}</strong></td>
          <td><input type="number" min="0" max="99" step="1" name="player${idx}_jersey" class="jersey-input" placeholder="#" inputmode="numeric" aria-label="Jersey number for player ${idx}" /></td>
          <td><input type="text" name="player${idx}_first" placeholder="First name" aria-label="First name for player ${idx}" /></td>
          <td><input type="text" name="player${idx}_last" placeholder="Last name" aria-label="Last name for player ${idx}" /></td>
          <td><input type="number" min="100" max="272" step="1" name="player${idx}_height" placeholder="CM" inputmode="numeric" class="jersey-input" aria-label="Height for player ${idx}" /></td>
          <td>
            <select name="player${idx}_position" aria-label="Position for player ${idx}">
              <option value="">-</option>
              <option value="G">G</option>
              <option value="F">F</option>
              <option value="C">C</option>
            </select>
          </td>
          <td><input type="email" name="player${idx}_email" placeholder="Email (optional)" aria-label="Email for player ${idx}" /></td>
        </tr>`;
    }

    function ensurePlayersRows(count) {
      const tbody = document.getElementById('playersTable');
      tbody.innerHTML = '';
      const n = Math.min(HARD_MAX_PLAYERS, Math.max(1, count|0));
      for (let i = 1; i <= n; i++) {
        tbody.insertAdjacentHTML('beforeend', playerRowTemplate(i));
      }
      hookDuplicateListeners();
      hookBulkSelectionListeners();
      hookEmailValidationListeners();
      hookHeightValidationListeners();
      bumpRowCount();
    }

    function addPlayersRow() {
      const tbody = document.getElementById('playersTable');
      const curr = document.querySelectorAll('#playersTable tr').length;
      if (curr >= HARD_MAX_PLAYERS) return;
      tbody.insertAdjacentHTML('beforeend', playerRowTemplate(curr + 1));
      hookDuplicateListeners();
      hookBulkSelectionListeners();
      hookEmailValidationListeners();
      hookHeightValidationListeners();
      bumpRowCount();
    }

    function removePlayersRow() {
      const tbody = document.getElementById('playersTable');
      const curr = document.querySelectorAll('#playersTable tr').length;
      if (curr <= 1) return;
      tbody.removeChild(tbody.lastElementChild);
      bumpRowCount();
      checkDuplicates();
      updateSelectAllState();
      saveCurrentTeamRoster();
    }

    function bumpRowCount() {
      const rows = document.querySelectorAll('#playersTable tr').length;
      document.getElementById('rowCountHelp').textContent = `${rows} rows (max ${HARD_MAX_PLAYERS})`;
    }

    // === Enhanced Email Validation for Players/Staff ===
    function hookEmailValidationListeners() {
      // Player email validation
      document.querySelectorAll('input[name*="_email"]').forEach(input => {
        input.removeEventListener('blur', handleEmailBlur);
        input.addEventListener('blur', handleEmailBlur);
        
        input.removeEventListener('input', handleEmailInput);
        input.addEventListener('input', handleEmailInput);
      });
    }

    function handleEmailInput(e) {
      e.target.classList.remove('input-error');
      e.target.removeAttribute('aria-invalid');
      
      const emailWarn = document.getElementById('emailWarn');
      if (emailWarn) {
        emailWarn.style.display = 'none';
        emailWarn.textContent = '';
      }
    }

    function handleEmailBlur(e) {
      const email = e.target.value.trim();
      if (!email) return;
      
      const result = emailValid(email);
      if (!result.ok && result.suggestion) {
        const useCorrection = confirm(`Email typo detected!\n\nDid you mean: ${result.suggestion}?`);
        if (useCorrection) {
          e.target.value = result.suggestion;
          saveCurrentTeamRoster();
        } else {
          const emailWarn = document.getElementById('emailWarn');
          if (emailWarn) {
            emailWarn.textContent = `Email typo detected. Suggested: ${result.suggestion}`;
            emailWarn.style.display = 'block';
          }
          e.target.classList.add('input-error');
          e.target.setAttribute('aria-invalid', 'true');
        }
      } else if (!result.ok) {
        const emailWarn = document.getElementById('emailWarn');
        if (emailWarn) {
          emailWarn.textContent = 'Invalid email address detected.';
          emailWarn.style.display = 'block';
        }
        e.target.classList.add('input-error');
        e.target.setAttribute('aria-invalid', 'true');
      } else {
        // Valid email - save changes
        saveCurrentTeamRoster();
      }
    }

    // === Bulk Operations ===
    function hookBulkSelectionListeners() {
      document.querySelectorAll('.player-select').forEach(checkbox => {
        checkbox.removeEventListener('change', handlePlayerSelectChange);
        checkbox.addEventListener('change', handlePlayerSelectChange);
      });
    }

    function handlePlayerSelectChange() {
      updateRowSelection(this);
      updateSelectAllState();
    }

    function updateRowSelection(checkbox) {
      const row = checkbox.closest('tr');
      if (checkbox.checked) {
        row.classList.add('selected-row');
      } else {
        row.classList.remove('selected-row');
      }
    }

    function updateSelectAllState() {
      const allCheckboxes = document.querySelectorAll('.player-select');
      const checkedBoxes = document.querySelectorAll('.player-select:checked');
      const selectAllBox = document.getElementById('selectAllPlayers');
      const statusSpan = document.getElementById('selectionCount');
      
      statusSpan.textContent = `${checkedBoxes.length} player${checkedBoxes.length !== 1 ? 's' : ''} selected`;
      
      if (checkedBoxes.length === 0) {
        selectAllBox.indeterminate = false;
        selectAllBox.checked = false;
      } else if (checkedBoxes.length === allCheckboxes.length) {
        selectAllBox.indeterminate = false;
        selectAllBox.checked = true;
      } else {
        selectAllBox.indeterminate = true;
        selectAllBox.checked = false;
      }
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllPlayers');
      const checkboxes = document.querySelectorAll('.player-select');
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        updateRowSelection(checkbox);
      });
      
      updateSelectAllState();
    }

    function applyBulkPosition() {
      const selectedPosition = document.getElementById('bulkPosition').value;
      const selectedCheckboxes = document.querySelectorAll('.player-select:checked');
      
      if (selectedCheckboxes.length === 0) {
        alert('Please select at least one player first.');
        return;
      }
      
      if (!selectedPosition) {
        alert('Please select a position to apply.');
        return;
      }
      
      selectedCheckboxes.forEach(checkbox => {
        const playerNum = checkbox.dataset.player;
        const positionSelect = document.querySelector(`select[name="player${playerNum}_position"]`);
        if (positionSelect) {
          positionSelect.value = selectedPosition;
        }
      });
      
      document.getElementById('bulkPosition').value = '';
      saveCurrentTeamRoster();
      flashOk(`Applied ${selectedPosition} position to ${selectedCheckboxes.length} player(s).`);
    }

    function clearSelected() {
      document.querySelectorAll('.player-select:checked').forEach(checkbox => {
        checkbox.checked = false;
        updateRowSelection(checkbox);
      });
      updateSelectAllState();
    }

    // === Enhanced Duplicate Detection ===
    let dupTimer;
    function hookDuplicateListeners() {
      document.querySelectorAll('input[name*="_jersey"]').forEach(inp => {
        inp.removeEventListener('input', dupHandler);
        inp.addEventListener('input', dupHandler);
      });
    }

    function dupHandler() {
      window.clearTimeout(dupTimer);
      dupTimer = window.setTimeout(() => {
        checkDuplicates();
        saveCurrentTeamRoster();
      }, 350);
    }

    function checkDuplicates() {
      const jerseyInputs = document.querySelectorAll('input[name*="_jersey"]');
      const counts = {};
      
      jerseyInputs.forEach(inp => {
        const v = normJersey(inp.value);
        if (v) counts[v] = (counts[v] || 0) + 1;
      });
      
      let hasDup = false;
      jerseyInputs.forEach(inp => {
        const v = normJersey(inp.value);
        if (v && counts[v] > 1) { 
          inp.classList.add('duplicate'); 
          hasDup = true; 
        } else { 
          inp.classList.remove('duplicate'); 
        }
      });
      
      const warn = document.getElementById('dupWarn');
      if (hasDup) { 
        warn.style.display = 'block'; 
        warn.textContent = '‚ö†Ô∏è Duplicate jersey numbers detected. Each player must have a unique number.'; 
      } else { 
        warn.style.display = 'none'; 
        warn.textContent = ''; 
      }
    }

    // === Enhanced Review Content ===
    function updateReviewContent() {
      let html = '<div class="overview-grid">';
      
      // Club overview
      html += '<div class="overview-card">';
      html += '<h3>üèÜ Club Information</h3>';
      html += `<p><strong>Club:</strong> ${clubData.clubName}</p>`;
      html += `<p><strong>Season:</strong> ${seasonLabel(parseInt(clubData.season.split('-')[0], 10))}</p>`;
      html += `<p><strong>Submitted by:</strong> ${clubData.submitterName}</p>`;
      html += `<p><strong>Email:</strong> ${clubData.submitterEmail}</p>`;
      html += '</div>';
      
      // Teams overview
      html += '<div class="overview-card">';
      html += `<h3>üë• Teams (${clubData.teams.length})</h3>`;
      html += '<div class="overview-stats">';
      const completeTeams = clubData.teams.filter(hasCompleteRoster).length;
      html += `<div class="stat"><div class="stat-number">${completeTeams}</div><div class="stat-label">Complete</div></div>`;
      html += `<div class="stat"><div class="stat-number">${clubData.teams.length - completeTeams}</div><div class="stat-label">Incomplete</div></div>`;
      const totalPlayers = clubData.teams.reduce((sum, team) => sum + (team.players?.filter(p => p.jersey && p.first && p.last).length || 0), 0);
      html += `<div class="stat"><div class="stat-number">${totalPlayers}</div><div class="stat-label">Total Players</div></div>`;
      html += '</div>';
      html += '</div>';
      
      html += '</div>';
      
      // Detailed team breakdown
      clubData.teams.forEach(team => {
        const fullName = getFullTeamName(team);
        const completePlayers = team.players?.filter(p => p.jersey && p.first && p.last && p.position) || [];
        const completeStaff = team.staff?.filter(s => s.first && s.last) || [];
        
        html += '<div class="overview-card">';
        html += `<h3>üèÄ ${fullName}</h3>`;
        if (team.nickname && team.nickname.trim()) {
          html += `<p><strong>Nickname:</strong> ${team.nickname}</p>`;
        }
        html += `<p><strong>Age Group:</strong> ${team.ageGroup} (${ageGroupToEnglish(team.ageGroup)})</p>`;
        html += `<p><strong>League:</strong> ${team.league} (${leagueToEnglish(team.league)})</p>`;
        
        html += '<div class="overview-stats">';
        html += `<div class="stat"><div class="stat-number">${completePlayers.length}</div><div class="stat-label">Players</div></div>`;
        html += `<div class="stat"><div class="stat-number">${completeStaff.length}</div><div class="stat-label">Staff</div></div>`;
        html += '</div>';
        
        if (completePlayers.length > 0) {
          html += '<h4>Players:</h4><ul style="margin: 0; padding-left: 20px; font-size: 14px;">';
          completePlayers.forEach(p => {
            const heightText = p.height ? ` | Height: ${p.height}cm` : '';
            const emailText = p.email ? ` | ${p.email}` : '';
            html += `<li>#${p.jersey} ${p.first} ${p.last} (${positionToFullName(p.position)})${heightText}${emailText}</li>`;
          });
          html += '</ul>';
        } else {
          html += '<p style="color: #ef4444; font-weight: 600;">‚ö†Ô∏è No players added</p>';
        }
        
        if (completeStaff.length > 0) {
          html += '<h4>Staff:</h4><ul style="margin: 8px 0 0 20px; padding-left: 20px; font-size: 14px;">';
          completeStaff.forEach(s => {
            const emailText = s.email ? ` | ${s.email}` : '';
            const phoneText = s.phone ? ` | ${s.phone}` : '';
            html += `<li><strong>${s.role}:</strong> ${s.first} ${s.last}${emailText}${phoneText}</li>`;
          });
          html += '</ul>';
        } else {
          html += '<p style="color: #ef4444; font-weight: 600;">‚ö†Ô∏è No coaching staff added</p>';
        }
        
        html += '</div>';
      });
      
      document.getElementById('reviewContent').innerHTML = html;
    }

    // === Enhanced Data Export & Processing ===
    function buildSubmissionData() {
      return {
        clubName: clubData.clubName,
        season: clubData.season,
        submitterName: clubData.submitterName,
        submitterEmail: clubData.submitterEmail,
        teams: clubData.teams.map(team => ({
          nickname: team.nickname || '',
          fullName: getFullTeamName(team),
          ageGroup: team.ageGroup,
          ageGroupEnglish: ageGroupToEnglish(team.ageGroup),
          league: team.league,
          leagueEnglish: leagueToEnglish(team.league),
          players: team.players?.filter(p => p.jersey && p.first && p.last && p.position).map(p => ({
            jersey: p.jersey,
            firstName: p.first,
            lastName: p.last,
            height: p.height || '',
            position: p.position,
            email: p.email || ''
          })) || [],
          staff: team.staff?.filter(s => s.first || s.last).map(s => ({
            role: s.role,
            firstName: s.firstName || '',
            lastName: s.last || '',
            email: s.email || '',
            phone: s.phone || ''
          })) || []
        }))
      };
    }

    function buildSubmissionSummary(data) {
      let summary = '';
      summary += 'IBBA MULTI-TEAM ROSTER SUBMISSION\n';
      summary += '===================================\n\n';
      summary += `Club: ${data.clubName}\n`;
      summary += `Season: ${data.season}\n`;
      summary += `Submitted by: ${data.submitterName}\n`;
      summary += `Email: ${data.submitterEmail}\n`;
      summary += `Date: ${new Date().toLocaleString()}\n`;
      summary += `Version: ${APP_VERSION}\n`;
      summary += `Total Teams: ${data.teams.length}\n`;
      summary += `Total Players: ${data.teams.reduce((sum, team) => sum + team.players.length, 0)}\n\n`;
      
      data.teams.forEach((team, idx) => {
        summary += `TEAM ${idx + 1}: ${team.fullName}\n`;
        if (team.nickname && team.nickname.trim()) {
          summary += `Nickname: ${team.nickname}\n`;
        }
        summary += `Age Group: ${team.ageGroupEnglish}\n`;
        summary += `League: ${team.leagueEnglish}\n`;
        summary += `Players: ${team.players.length}\n`;
        summary += `Staff: ${team.staff.length}\n\n`;
        
        if (team.players.length > 0) {
          summary += 'CSV FORMAT FOR COPYING:\n';
          summary += '=======================\n';
          team.players.forEach(p => {
            const email = p.email || '';
            summary += `${p.jersey},${p.firstName},${p.lastName},${email},${p.position}\n`;
          });
          summary += '\n';
          
          summary += 'PLAYERS:\n';
          summary += '------------------------\n';
          team.players.forEach(p => {
            const heightText = p.height ? ` | Height: ${p.height}cm` : '';
            const emailText = p.email ? ` | ${p.email}` : '';
            summary += `#${p.jersey} - ${p.firstName} ${p.lastName} (${positionToFullName(p.position)})${heightText}${emailText}\n`;
          });
          summary += '\n';
        }
        
        if (team.staff.length > 0) {
          summary += 'COACHING STAFF:\n';
          summary += '----------------------------\n';
          team.staff.forEach(s => {
            const emailText = s.email ? ` | ${s.email}` : '';
            const phoneText = s.phone ? ` | ${s.phone}` : '';
            summary += `${s.role}: ${s.firstName} ${s.lastName}${emailText}${phoneText}\n`;
          });
          summary += '\n';
        }
        
        summary += '---\n\n';
      });
      
      return summary;
    }

    function downloadCSV(data) {
      const BOM = '\uFEFF';
      let csv = `IBBA Multi-Team Roster Submission - Pixellot Advantage - Version ${APP_VERSION}\n`;
      csv += `Generated: ${new Date().toLocaleString()}\n\n`;
      csv += `Club Name: ${data.clubName}\n`;
      csv += `Season: ${data.season} (${seasonLabel(parseInt(data.season.split('-')[0], 10))})\n`;
      csv += `Submitted by: ${data.submitterName}\n`;
      csv += `Contact Email: ${data.submitterEmail}\n`;
      csv += `Total Teams: ${data.teams.length}\n\n`;
      
      data.teams.forEach((team, idx) => {
        csv += `TEAM ${idx + 1}: ${team.fullName}\n`;
        if (team.nickname && team.nickname.trim()) {
          csv += `Nickname: ${team.nickname}\n`;
        }
        csv += `Age Group: ${team.ageGroupEnglish}\n`;
        csv += `League: ${team.leagueEnglish}\n\n`;
        
        if (team.players.length > 0) {
          csv += 'PLAYERS\n';
          csv += 'Jersey,First Name,Last Name,Email,Position,Height\n';
          team.players.forEach(p => {
            csv += `${p.jersey},"${p.firstName}","${p.lastName}","${p.email}","${p.position}","${p.height}"\n`;
          });
          csv += '\n';
        }
        
        if (team.staff.length > 0) {
          csv += 'STAFF\n';
          csv += 'First Name,Last Name,Email,Phone,Role\n';
          team.staff.forEach(s => {
            csv += `"${s.firstName}","${s.lastName}","${s.email}","${s.phone}","${s.role}"\n`;
          });
          csv += '\n';
        }
        
        csv += '---\n\n';
      });
      
      const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ibba_${data.clubName.replace(/[^a-z0-9\u0590-\u05FF]/gi, '_').toLowerCase()}_${data.season}_multi_team_roster_v${APP_VERSION.replace(/[^a-z0-9]/gi, '_')}.csv`;
      document.body.appendChild(a); 
      a.click(); 
      document.body.removeChild(a); 
      URL.revokeObjectURL(url);
    }

    // === Enhanced Local Storage ===
    function saveDraft() {
      if (activeTeamId) {
        saveCurrentTeamRoster();
      }
      
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ 
          ...clubData, 
          currentStep,
          activeTeamId,
          teamIdCounter 
        }));
        flashOk('Draft saved locally.');
      } catch (e) {
        alert('Failed to save draft. Your browser may have storage restrictions.');
      }
    }

    function restoreDraft() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) { 
          alert('No draft found.'); 
          return; 
        }
        
        const saved = JSON.parse(raw);
        clubData = {
          clubName: saved.clubName || '',
          season: saved.season || '',
          submitterName: saved.submitterName || '',
          submitterEmail: saved.submitterEmail || '',
          teams: saved.teams || []
        };
        
        currentStep = saved.currentStep || 1;
        activeTeamId = saved.activeTeamId || null;
        teamIdCounter = saved.teamIdCounter || clubData.teams.length + 1;
        
        // Restore form fields
        document.getElementById('clubName').value = clubData.clubName;
        document.getElementById('season').value = clubData.season;
        document.getElementById('submitterName').value = clubData.submitterName;
        document.getElementById('submitterEmail').value = clubData.submitterEmail;
        
        renderTeams();
        showStep(currentStep);
        updateProgress();
        
        if (currentStep === 3) {
          updateRosterView();
        }
        
        flashOk('Draft restored.');
      } catch (e) {
        alert('Failed to restore draft. Data may be corrupted.');
      }
    }

    function flashOk(msg) { 
      const el = document.getElementById('okMsg'); 
      el.textContent = `‚úÖ ${msg}`; 
      el.style.display = 'block'; 
      setTimeout(() => el.style.display = 'none', 3000); 
    }

    // === Enhanced Email & Data Submission ===
    async function sendEmailViaAPI(params, options = {}) {
      const url = 'https://api.emailjs.com/api/v1.0/email/send';
      const payload = {
        service_id: EmailJSConfig.serviceId,
        template_id: EmailJSConfig.templateId,
        user_id: EmailJSConfig.publicKey,
        template_params: params
      };
      
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
        signal: options.signal
      });
      
      if (!response.ok) {
        throw new Error(`Email API responded ${response.status}`);
      }
      
      return response;
    }

    async function sendToSheet(submissionData) {
      if (!DATA_SINK_URL) return true;
      
      const url = `${DATA_SINK_URL}?key=${encodeURIComponent(DATA_SINK_KEY)}`;
      const payload = {
        app_version: APP_VERSION,
        build_date: BUILD_DATE,
        club_name: submissionData.clubName,
        season: submissionData.season,
        submitter_name: submissionData.submitterName,
        submitter_email: submissionData.submitterEmail,
        teams: submissionData.teams,
        total_teams: submissionData.teams.length,
        total_players: submissionData.teams.reduce((sum, team) => sum + team.players.length, 0),
        submission_type: 'multi_team'
      };
      
      for (let attempt = 1; attempt <= 3; attempt++) {
        try {
          await fetch(url, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(payload)
          });
          return true;
        } catch (error) {
          if (attempt === 3) throw error;
          await new Promise(resolve => setTimeout(resolve, 400 * attempt));
        }
      }
    }

    async function submitAllTeams() {
      const submitBtn = document.getElementById('submitBtn');
      const loading = document.getElementById('loading');
      const ok = document.getElementById('okMsg');
      
      ok.style.display = 'none';
      submitBtn.disabled = true;
      loading.style.display = 'block';
      
      try {
        const submissionData = buildSubmissionData();
        
        const emailParams = {
          team_name: `${submissionData.clubName} (v${APP_VERSION})`,
          league: `Multi-Team Submission (${submissionData.teams.length} teams)`,
          submitter_name: submissionData.submitterName,
          submitter_email: submissionData.submitterEmail,
          season: submissionData.season,
          total_teams: submissionData.teams.length,
          total_players: submissionData.teams.reduce((sum, team) => sum + team.players.length, 0),
          roster_data: buildSubmissionSummary(submissionData)
        };
        
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 15000);
        
        const sheetPromise = sendToSheet(submissionData).catch(err => {
          console.warn('Google Sheet error:', err);
          return false;
        });
        
        try {
          await sendEmailViaAPI(emailParams, { signal: controller.signal });
          await sheetPromise;
          downloadCSV(submissionData);
          
          ok.textContent = `‚úÖ All ${submissionData.teams.length} team rosters submitted successfully! Email sent, data logged, and CSV downloaded.`;
          ok.style.display = 'block';
          document.getElementById('newBtn').style.display = 'inline-block';
          
        } catch (emailError) {
          console.error('Email sending failed:', emailError);
          await sheetPromise;
          downloadCSV(submissionData);
          
          alert('Email sending failed. CSV file downloaded instead. Please email it to pixellotibba@gmail.com.');
          ok.textContent = `‚ö†Ô∏è Email failed but ${submissionData.teams.length} team rosters processed. CSV downloaded as fallback.`;
          ok.style.display = 'block';
          document.getElementById('newBtn').style.display = 'inline-block';
        }
        
        clearTimeout(timeout);
        
      } catch (err) {
        console.error('Submission error:', err);
        alert('Submission failed. CSV file will be downloaded instead.');
        const submissionData = buildSubmissionData();
        downloadCSV(submissionData);
        ok.textContent = '‚ö†Ô∏è Submission error. CSV downloaded as fallback.';
        ok.style.display = 'block';
        document.getElementById('newBtn').style.display = 'inline-block';
      } finally {
        submitBtn.disabled = false;
        loading.style.display = 'none';
      }
    }

    // === Enhanced Event Handlers ===
    function clearAllData() {
      try {
        clubData = {
          clubName: '',
          season: '',
          submitterName: '',
          submitterEmail: '',
          teams: []
        };
        
        activeTeamId = null;
        teamIdCounter = 1;
        currentStep = 1;
        
        const form = document.getElementById('clubForm');
        if (form) form.reset();
        
        populateSeasonSelect();
        renderTeams();
        
        currentStep = 1;
        showStep(1);
        updateProgress();
        
        // Clear all status messages and errors
        document.querySelectorAll('.field-error').forEach(el => {
          el.style.display = 'none';
          el.textContent = '';
        });
        
        document.querySelectorAll('.input-error').forEach(el => {
          el.classList.remove('input-error');
          el.removeAttribute('aria-invalid');
        });
        
        ['dupWarn', 'emailWarn', 'okMsg', 'newBtn'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = 'none';
        });
        
        updateNextButtonState();
        return true;
        
      } catch (error) {
        console.error('Clear all failed:', error);
        alert('Clear failed: ' + error.message);
        return false;
      }
    }

    function setupEventListeners() {
      // Navigation
      document.getElementById('nextBtn').addEventListener('click', (e) => {
        e.preventDefault();
        nextStep();
      });
      document.getElementById('prevBtn').addEventListener('click', prevStep);
      
      // Team management
      document.getElementById('addTeamCard').addEventListener('click', addTeam);
      
      // Roster management
      document.getElementById('addRowBtn').addEventListener('click', addPlayersRow);
      document.getElementById('removeRowBtn').addEventListener('click', removePlayersRow);
      
      // Bulk operations
      document.getElementById('selectAllPlayers').addEventListener('change', toggleSelectAll);
      document.getElementById('applyBulkPosition').addEventListener('click', applyBulkPosition);
      document.getElementById('clearSelected').addEventListener('click', clearSelected);
      
      // Enhanced form field validation
      const submitterEmailField = document.getElementById('submitterEmail');
      submitterEmailField.addEventListener('input', () => clearFieldError(submitterEmailField, 'submitterEmailError'));
      submitterEmailField.addEventListener('blur', function() {
        const result = emailValid(this.value);
        if (!result.ok && !result.suggestion && this.value.trim()) {
          showFieldError(this, 'Please enter a valid email address.', 'submitterEmailError');
        }
      });
      
      // Clear field errors on input
      ['clubName', 'season', 'submitterName'].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', () => clearFieldError(field, fieldId + 'Error'));
        }
      });
      
      // Form controls
      document.getElementById('clearBtn').addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        if (!confirm('Clear all data and start over?')) return;
        
        const success = clearAllData();
        if (success) {
          flashOk('‚úÖ All data cleared successfully! Form is now empty.');
        } else {
          alert('‚ùå Clear failed - check console for details');
        }
      });
      
      document.getElementById('newBtn').addEventListener('click', () => {
        const keepName = clubData.submitterName;
        const keepEmail = clubData.submitterEmail;
        
        clubData = {
          clubName: '',
          season: '',
          submitterName: keepName,
          submitterEmail: keepEmail,
          teams: []
        };
        
        activeTeamId = null;
        teamIdCounter = 1;
        currentStep = 1;
        
        document.getElementById('clubForm').reset();
        populateSeasonSelect();
        document.getElementById('submitterName').value = keepName;
        document.getElementById('submitterEmail').value = keepEmail;
        renderTeams();
        showStep(currentStep);
        updateProgress();
        
        ['dupWarn', 'emailWarn', 'okMsg', 'newBtn'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = 'none';
        });
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });

      document.getElementById('saveBtn').addEventListener('click', saveDraft);
      document.getElementById('restoreBtn').addEventListener('click', restoreDraft);

      // Form submission
      document.getElementById('clubForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!emailValid(clubData.submitterEmail).ok) {
          alert('Please enter a valid email address.');
          return;
        }
        
        await submitAllTeams();
      });
      
      // Auto-save and validation on roster changes
      document.addEventListener('change', (e) => {
        if (currentStep === 3 && (
            e.target.matches('input[name*="player"]') ||
            e.target.matches('select[name*="player"]') ||
            e.target.matches('input[name*="coach"]') ||
            e.target.matches('input[name*="asst"]') ||
            e.target.matches('input[name*="gm"]')
        )) {
          clearTimeout(window.rosterUpdateTimeout);
          window.rosterUpdateTimeout = setTimeout(() => {
            saveCurrentTeamRoster();
            updateNextButtonState();
          }, 100);
        }
      });
      
      // Update button state on input changes
      document.addEventListener('input', (e) => {
        if (currentStep === 1 && e.target.matches('.form-step[data-step="1"] [required]')) {
          clearTimeout(window.buttonUpdateTimeout);
          window.buttonUpdateTimeout = setTimeout(updateNextButtonState, 150);
        }
      });
    }

    // === Initialize ===
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('versionBadge').textContent = `Version ${APP_VERSION}`;
      populateSeasonSelect();
      updateProgress();
      renderTeams();
      setupEventListeners();
      
      // Initial validation state
      setTimeout(() => {
        updateNextButtonState();
      }, 100);
    });
  </script>
</body>
</html>
